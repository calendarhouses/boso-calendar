<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BOSO Booking</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; text-align: center; background-color: #f9f6f0; overflow-x: hidden; }
        .bosman-avatar { width: 120px; height: 120px; border-radius: 50%; border: 4px solid #8f9779; margin-bottom: 10px; object-fit: cover; transition: 0.3s; }
        .step-container { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); max-width: 320px; margin: 0 auto; display: none; opacity: 0; transform: translateY(10px); transition: all 0.4s ease; }
        .step-container.active { opacity: 1; transform: translateY(0); }
        h2 { color: #2c3e50; font-size: 20px; margin-top: 5px; margin-bottom: 5px; }
        p.subtitle { color: #7f8c8d; font-size: 14px; margin-top: 0; margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; text-align: center; font-size: 16px; outline: none; box-sizing: border-box; margin-bottom: 15px; }
        button { background-color: #8f9779; color: white; border: none; padding: 15px; width: 100%; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
        .btn-outline { background-color: white; color: #8f9779; border: 2px solid #8f9779; }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å—ñ—Ç–∫–∏ –∫–Ω–æ–ø–æ–∫ –≥–æ—Å—Ç–µ–π */
        .guest-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 15px; }
        .guest-btn { background-color: white; color: #8f9779; border: 2px solid #8f9779; padding: 15px 5px; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-bottom: 0; }
        .guest-btn:hover { background-color: #8f9779; color: white; }
        
        #message { margin-top: 15px; font-weight: bold; font-size: 16px; display: none; }
    </style>
</head>
<body>

    <img id="main-img" src="bosman.jpg" alt="–ö–∞–ø—ñ—Ç–∞–Ω –ë–æ—Å–º–∞–Ω" class="bosman-avatar" onerror="this.src='https://via.placeholder.com/120?text=BOSO'">
    <h2 id="main-title">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç–∏ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É ‚öì</h2>
    <p id="main-subtitle" class="subtitle">–ö–æ–ª–∏ –ø–ª–∞–Ω—É—î—Ç–µ –∑–∞—ó–∑–¥ —Ç–∞ –≤–∏—ó–∑–¥?</p>

    <div id="step-1" class="step-container active" style="display: block;">
        <input type="text" id="dateRange" placeholder="–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –¥–ª—è –≤–∏–±–æ—Ä—É..." readonly>
        <button onclick="goToStep2()">–î–∞–ª—ñ</button>
    </div>

    <div id="step-2" class="step-container">
        <div id="guest-buttons" class="guest-grid"></div>
        <button class="btn-outline" onclick="goBack(1)" style="padding: 10px; font-size: 14px; margin-top: 5px;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="step-3" class="step-container">
        <button onclick="goToStep4('–¢–∞–∫')">üê∂ –¢–∞–∫, –º–∏ –∑ —Ö–≤–æ—Å—Ç–∏–∫–æ–º</button>
        <button class="btn-outline" onclick="goToStep4('–ù—ñ')">–ù—ñ, –±–µ–∑ —Ç–≤–∞—Ä–∏–Ω</button>
        <button class="btn-outline" onclick="goBack(2)" style="border: none; margin-top: 10px;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="step-4" class="step-container">
        <button onclick="submitData('–¢–∞–∫')">‚ô®Ô∏è –¢–∞–∫, –æ–±–æ–≤'—è–∑–∫–æ–≤–æ!</button>
        <button class="btn-outline" onclick="submitData('–ù—ñ')">–ù—ñ, –¥—è–∫—É—é</button>
        <button class="btn-outline" onclick="goBack(3)" style="border: none; margin-top: 10px;">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="message">‚öì –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –≤—ñ–ª—å–Ω—ñ –¥–∞—Ç–∏...</div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/uk.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg) { tg.expand(); tg.ready(); }

        const urlParams = new URLSearchParams(window.location.search);
        const userId = tg.initDataUnsafe?.user?.id || urlParams.get('user_id');
        const roomId = urlParams.get('room_id');

        let finalCheckIn = "", finalCheckOut = "", finalGuests = "", finalPets = "";

        const fp = flatpickr("#dateRange", { mode: "range", minDate: "today", locale: "uk", dateFormat: "Y-m-d" });

        function updateHeader(title, subtitle) {
            document.getElementById('main-title').innerText = title;
            document.getElementById('main-subtitle').innerText = subtitle;
        }

        function showStep(stepNumber) {
            document.querySelectorAll('.step-container').forEach(el => {
                el.style.display = 'none'; 
                el.classList.remove('active');
            });
            setTimeout(() => { 
                let current = document.getElementById('step-' + stepNumber);
                current.style.display = 'block'; 
                setTimeout(() => current.classList.add('active'), 10);
            }, 10);
        }

        function goToStep2() {
            if (fp.selectedDates.length < 2) { alert("‚öì –û–±–µ—Ä—ñ—Ç—å –∑–∞—ó–∑–¥ —Ç–∞ –≤–∏—ó–∑–¥!"); return; }
            finalCheckIn = fp.formatDate(fp.selectedDates[0], "Y-m-d");
            finalCheckOut = fp.formatDate(fp.selectedDates[1], "Y-m-d");
            
            // –î–∏–Ω–∞–º—ñ—á–Ω—ñ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –≥–æ—Å—Ç–µ–π
            const juniorId = "65e8865b5cc7538d464e3f77";
            const maxGuests = (roomId === juniorId) ? 2 : 6;
            
            const guestDiv = document.getElementById("guest-buttons");
            guestDiv.innerHTML = ""; // –û—á–∏—â–∞—î–º–æ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—î—é
            
            // –Ø–∫—â–æ Junior (2 –∫–Ω–æ–ø–∫–∏), —Ä–æ–±–∏–º–æ —ó—Ö —à–∏—Ä—à–∏–º–∏. –Ø–∫—â–æ Family (6) - —Å—ñ—Ç–∫–æ—é.
            guestDiv.style.gridTemplateColumns = (maxGuests === 2) ? "repeat(2, 1fr)" : "repeat(3, 1fr)";

            for(let i = 1; i <= maxGuests; i++) {
                let btn = document.createElement("button");
                btn.className = "guest-btn";
                btn.innerText = i + " üë§";
                btn.onclick = function() {
                    finalGuests = i;
                    goToStep3(); // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –ø–µ—Ä–µ—Ö—ñ–¥ –±–µ–∑ –∫–Ω–æ–ø–∫–∏ "–î–∞–ª—ñ"
                };
                guestDiv.appendChild(btn);
            }

            updateHeader("–°–∫—ñ–ª—å–∫–∏ –≤–∞—Å –±—É–¥–µ?", "–û–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Å—ñ–±"); 
            showStep(2);
        }

        function goToStep3() {
            if (!finalGuests) { alert("–û–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –≥–æ—Å—Ç–µ–π!"); return; }
            updateHeader("–í–∏ –∑ –ø—É—Ö–Ω–∞—Å—Ç–∏–∫–æ–º?", "–ú–∏ –¥—Ä—É–∂–Ω—ñ –¥–æ —Ç–≤–∞—Ä–∏–Ω"); showStep(3);
        }

        function goToStep4(petAnswer) {
            finalPets = petAnswer;
            updateHeader("–ë–∞–∂–∞—î—Ç–µ –≥–∞—Ä—è—á–∏–π —á–∞–Ω?", "–Ü–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –≤–µ—á—ñ—Ä–Ω—å–æ–≥–æ —Ä–µ–ª–∞–∫—Å—É"); showStep(4);
        }

        function goBack(stepNumber) {
            if(stepNumber === 1) updateHeader("–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç–∏ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É ‚öì", "–ö–æ–ª–∏ –ø–ª–∞–Ω—É—î—Ç–µ –∑–∞—ó–∑–¥ —Ç–∞ –≤–∏—ó–∑–¥?");
            if(stepNumber === 2) updateHeader("–°–∫—ñ–ª—å–∫–∏ –≤–∞—Å –±—É–¥–µ?", "–û–±–µ—Ä—ñ—Ç—å –∫—ñ–ª—å–∫—ñ—Å—Ç—å –æ—Å—ñ–±");
            if(stepNumber === 3) updateHeader("–í–∏ –∑ –ø—É—Ö–Ω–∞—Å—Ç–∏–∫–æ–º?", "–ú–∏ –¥—Ä—É–∂–Ω—ñ –¥–æ —Ç–≤–∞—Ä–∏–Ω");
            showStep(stepNumber);
        }

        function submitData(chanAnswer) {
            if (!roomId) { alert("–ö–∞–ø—ñ—Ç–∞–Ω –Ω–µ –±–∞—á–∏—Ç—å, —è–∫–∏–π –∫–æ—Ç–µ–¥–∂ –≤–∏ –æ–±—Ä–∞–ª–∏! –ó–∞–∫—Ä–∏–π—Ç–µ –∫–∞–ª–µ–Ω–¥–∞—Ä —ñ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É —â–µ —Ä–∞–∑."); return; }

            document.querySelectorAll('.step-container').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });

            const msgDiv = document.getElementById('message');
            msgDiv.style.display = 'block';
            msgDiv.style.color = "#8f9779";
            msgDiv.innerText = "‚öì –ó–∞—á–µ–∫–∞–π—Ç–µ, –ö–∞–ø—ñ—Ç–∞–Ω –∑–≤—ñ—Ä—è—î –∫–∞—Ä—Ç–∏..."; 
            
            updateHeader("–ú–∞–π–∂–µ –≥–æ—Ç–æ–≤–æ!", "–ó–≤—ñ—Ä—è—î–º–æ –∫–∞—Ä—Ç–∏...");

            const googleUrl = "https://script.google.com/macros/s/AKfycbwQNcWFZPXQHNY4VRUUujMIqJsHXA5O-vNmvKICxwQfiJfQH71AZlHQUU74OSFfwEOxrw/exec";
            const finalUrl = `${googleUrl}?userId=${userId}&checkIn=${finalCheckIn}&checkOut=${finalCheckOut}&guests=${finalGuests}&pets=${finalPets}&chan=${chanAnswer}&roomId=${roomId}`;

            fetch(finalUrl)
                .then(response => response.text())
                .then(data => {
                    if (data.includes("–ó–∞–π–Ω—è—Ç–æ")) {
                        msgDiv.style.color = "#e74c3c"; 
                        msgDiv.innerText = "‚ö†Ô∏è –ù–∞ –∂–∞–ª—å, —Ü—ñ –¥–∞—Ç–∏ –≤–∂–µ –∑–∞–π–Ω—è—Ç—ñ –µ–∫—ñ–ø–∞–∂–µ–º! –û–±–µ—Ä—ñ—Ç—å —ñ–Ω—à—ñ.";
                        setTimeout(() => { 
                            msgDiv.style.display = 'none';
                            fp.clear(); 
                            goBack(1); 
                        }, 3500);
                    } else if (data.includes("Error")) {
                        msgDiv.style.color = "#e74c3c";
                        msgDiv.innerText = "‚ùå –®—Ç–æ—Ä–º –Ω–∞ –ª—ñ–Ω—ñ—ó! –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –≤ —á–∞—Ç.";
                        setTimeout(() => { if (tg) tg.close(); }, 2500);
                    } else {
                        msgDiv.style.color = "#4CAF50"; 
                        msgDiv.innerText = "‚úÖ –î–∞—Ç–∏ —Ç–∏–º—á–∞—Å–æ–≤–æ –∑–∞–±—Ä–æ–Ω—å–æ–≤–∞–Ω–æ! –ü–æ–≤–µ—Ä—Ç–∞–π—Ç–µ—Å—è –≤ —á–∞—Ç –¥–ª—è –æ–ø–ª–∞—Ç–∏.";
                        setTimeout(() => { if (tg) tg.close(); }, 2500);
                    }
                })
                .catch(e => {
                    msgDiv.style.color = "#4CAF50";
                    msgDiv.innerText = "‚úÖ –ü–µ—Ä–µ–≤—ñ—Ä—è–π—Ç–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤ Telegram";
                    setTimeout(() => { if (tg) tg.close(); }, 2500);
                });
        }
    </script>
</body>
</html>
