<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä - BOSO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; text-align: center; background-color: #f9f6f0; }
        .bosman-avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #8f9779; margin-bottom: 10px; object-fit: cover; }
        h2 { color: #2c3e50; font-size: 22px; margin-top: 5px; margin-bottom: 5px; font-weight: 700; }
        p.subtitle { color: #7f8c8d; font-size: 14px; margin-top: 0; margin-bottom: 20px; }
        
        /* –í–∏–ø–∞–¥–∞—é—á–∏–π —Å–ø–∏—Å–æ–∫ */
        .select-css {
            display: block; font-size: 16px; font-weight: 500; color: #2c3e50; padding: 14px 20px;
            width: 100%; max-width: 320px; margin: 0 auto 20px auto; border: 1px solid #dcdacb;
            border-radius: 12px; background-color: #fcfbf8; appearance: none; outline: none; cursor: pointer;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238f9779%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat; background-position: right 1em top 50%; background-size: .65em auto;
        }

        #calendar-container { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); display: inline-block; margin-bottom: 20px; }
        #loader { color: #8f9779; font-weight: bold; margin-bottom: 15px; }
        
        /* –ë–ª–æ–∫ —Ü—ñ–Ω–∏ */
        #price-result { display: none; background: #fff; border: 2px solid #8f9779; border-radius: 12px; padding: 20px; margin: 0 auto 20px auto; max-width: 300px; box-shadow: 0 6px 15px rgba(143, 151, 121, 0.15); }
        .price-nights { font-size: 15px; color: #7f8c8d; margin-bottom: 8px; font-weight: 500; }
        
        /* –¶—ñ–Ω–∏ –≤ —Å—Ç–æ–≤–ø—á–∏–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É */
        .price-total { 
            display: flex; 
            flex-direction: column;
            justify-content: center; 
            align-items: center;
            margin: 0; 
        }
        .old-price {
            text-decoration: line-through; 
            color: #aab7b8; 
            font-size: 16px;
            font-weight: 600;
            margin-top: 8px; /* –í—ñ–¥—Å—Ç—É–ø –∑–≤–µ—Ä—Ö—É –≤—ñ–¥ –≥–æ–ª–æ–≤–Ω–æ—ó —Ü—ñ–Ω–∏ */
        }
        .new-price {
            font-size: 26px; 
            color: #2c3e50; 
            font-weight: 800;
        }
        
        /* –°—Ç–∏–ª—ñ –∫–∞–ª–µ–Ω–¥–∞—Ä—è */
        .flatpickr-day { border-radius: 50%; }
        .flatpickr-day.selected, .flatpickr-day.startRange, .flatpickr-day.endRange { background-color: #8f9779 !important; border-color: #8f9779 !important; color: white !important; }
        
        .flatpickr-day.selected.startRange + .endRange, .flatpickr-day.startRange.startRange + .endRange, .flatpickr-day.endRange.startRange + .endRange {
            box-shadow: none !important;
        }

        .flatpickr-day.inRange {
            background-color: #e8eae6 !important; 
            border-color: #e8eae6 !important;
            border-radius: 0 !important; 
            box-shadow: -5px 0 0 #e8eae6, 5px 0 0 #e8eae6 !important; 
        }
        .flatpickr-day.flatpickr-disabled { color: #ff9999 !important; text-decoration: line-through; }
    </style>
</head>
<body>

    <img src="bosman.jpg" alt="BOSO" class="bosman-avatar" onerror="this.src='https://via.placeholder.com/100?text=BOSO'">
    <h2>–ü—Ä–∏—Ü—ñ–Ω–∏—Ç–∏—Å—è –¥–æ –≤—ñ–¥–ø–æ—á–∏–Ω–∫—É ‚öì</h2>
    <p class="subtitle">–û–±–µ—Ä—ñ—Ç—å –∫–æ—Ç–µ–¥–∂ —Ç–∞ –≤—ñ–ª—å–Ω—ñ –¥–∞—Ç–∏</p>

    <select id="cottageSelect" class="select-css" onchange="loadAvailability()">
        <option value="65e8865b5cc7538d464e3f77">JUNIOR 1 (–∫–æ—Ç–µ–¥–∂ –¥–ª—è –¥–≤–æ—Ö)</option>
        <option value="65e8834e5cc7538d464e3b46">FAMILY ‚Ññ2 (—Å—ñ–º–µ–π–Ω–∏–π –∫–æ—Ç–µ–¥–∂)</option>
        <option value="65e8863a5cc7538d464e3eab">FAMILY ‚Ññ3 (—Å—ñ–º–µ–π–Ω–∏–π –∫–æ—Ç–µ–¥–∂)</option>
        <option value="65e886505cc7538d464e3f1d">FAMILY ‚Ññ4 (—Å—ñ–º–µ–π–Ω–∏–π –∫–æ—Ç–µ–¥–∂)</option>
    </select>

    <div id="loader">‚è≥ –ó–≤—ñ—Ä—è—î–º–æ –±–æ—Ä—Ç–æ–≤—ñ –∂—É—Ä–Ω–∞–ª–∏...</div>

    <div id="calendar-container" style="display: none;">
        <input type="text" id="inlineCalendar" style="display:none;">
    </div>

    <div id="price-result">
        <div id="loading-state" style="color: #8f9779; font-weight: bold; display: none;">‚è≥ –†–∞—Ö—É—î–º–æ, –∑–∞—á–µ–∫–∞–π—Ç–µ...</div>
        <div id="final-price-state" style="display: none;">
            <div class="price-nights" id="nights-display">üåô –ó–∞ 0 –Ω–æ—á–µ–π</div>
            <div class="price-total" id="total-display">
                <span class="new-price">üí∞ 0 –≥—Ä–Ω</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/uk.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script>
        const tg = window.Telegram.WebApp;
        if (tg) { tg.expand(); tg.ready(); }

        const availabilityScriptUrl = "https://script.google.com/macros/s/AKfycbzsTNRpYZ38kHrurbQ9q289W7PJdrPDr614Zjc07FiyMy663CJowAl_Rtnsftwb_jQQ/exec";
        const calculatorScriptUrl = "https://script.google.com/macros/s/AKfycbwAkdrldfBpzv0zZLDyDqSNT9Ij30oiWz0Qb0BNwZGbK4Wtuj219VOu6tl3KWzAVB0m/exec";

        let fpInstance = null;
        let selectedCheckIn = "";
        let selectedCheckOut = "";
        let calcNights = 1;

        function getNightsText(n) {
            if (n % 10 === 1 && n % 100 !== 11) return n + " –Ω—ñ—á";
            if ([2, 3, 4].includes(n % 10) && ![12, 13, 14].includes(n % 100)) return n + " –Ω–æ—á—ñ";
            return n + " –Ω–æ—á–µ–π";
        }

        function loadAvailability() {
            const selectedRoomId = document.getElementById('cottageSelect').value;
            
            document.getElementById('loader').style.display = 'block';
            document.getElementById('calendar-container').style.display = 'none';
            document.getElementById('price-result').style.display = 'none';

            fetch(`${availabilityScriptUrl}?roomId=${selectedRoomId}`)
                .then(response => response.json())
                .then(disabledDatesArray => {
                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('calendar-container').style.display = 'inline-block';

                    if (fpInstance) fpInstance.destroy();

                    fpInstance = flatpickr("#inlineCalendar", {
                        inline: true,
                        mode: "range",
                        minDate: "today",
                        locale: "uk",
                        showMonths: 1,
                        disable: disabledDatesArray,
                        onChange: function(selectedDates, dateStr, instance) {
                            if (selectedDates.length === 2) {
                                selectedCheckIn = instance.formatDate(selectedDates[0], "Y-m-d");
                                selectedCheckOut = instance.formatDate(selectedDates[1], "Y-m-d");
                                
                                calcNights = Math.round((selectedDates[1] - selectedDates[0]) / (1000 * 60 * 60 * 24));
                                
                                getPrice(selectedRoomId, selectedCheckIn, selectedCheckOut);
                            } else {
                                document.getElementById('price-result').style.display = 'none';
                            }
                        }
                    });
                })
                .catch(error => {
                    document.getElementById('loader').innerText = "‚ùå –®—Ç–æ—Ä–º –Ω–∞ –ª—ñ–Ω—ñ—ó –∑–≤'—è–∑–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ.";
                });
        }

        function getPrice(roomId, checkIn, checkOut) {
            document.getElementById('price-result').style.display = 'block';
            document.getElementById('loading-state').style.display = 'block';
            document.getElementById('final-price-state').style.display = 'none';

            fetch(`${calculatorScriptUrl}?roomId=${roomId}&checkIn=${checkIn}&checkOut=${checkOut}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('loading-state').style.display = 'none';
                    
                    if(data.error) {
                        document.getElementById('nights-display').innerText = "‚ùå –®—Ç–æ—Ä–º!";
                        document.getElementById('total-display').innerHTML = `<span class="new-price" style="font-size:20px;">–î–∞—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ñ</span>`;
                    } else {
                        document.getElementById('nights-display').innerText = `üåô –ó–∞ ${getNightsText(calcNights)}`;
                        
                        // üî• –ó–ú–Ü–ù–ï–ù–û –ü–û–†–Ø–î–û–ö –Ü –°–ú–ê–ô–õ–ò–ö–ò
                        if (data.discount > 0) {
                             document.getElementById('total-display').innerHTML = `
                                <span class="new-price">üéÅ ${data.totalPrice} –≥—Ä–Ω</span>
                                <span class="old-price">üí∞ ${data.basePrice}</span>
                             `;
                        } else {
                             document.getElementById('total-display').innerHTML = `
                                <span class="new-price">üí∞ ${data.totalPrice} –≥—Ä–Ω</span>
                             `;
                        }
                    }
                    document.getElementById('final-price-state').style.display = 'block';
                })
                .catch(error => {
                    document.getElementById('loading-state').innerText = "‚ùå –ü–æ–º–∏–ª–∫–∞ –∑–≤'—è–∑–∫—É";
                });
        }

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomIdFromUrl = urlParams.get('room_id');
            const selectElem = document.getElementById('cottageSelect');
            
            if (roomIdFromUrl) {
                for(let i=0; i < selectElem.options.length; i++) {
                    if(selectElem.options[i].value === roomIdFromUrl) {
                        selectElem.selectedIndex = i;
                        break;
                    }
                }
            }
            loadAvailability();
        };
    </script>
</body>
</html>
